# SUMO & Carla 联调仿真

  使用基于交通微观仿真的专业系统SUMO搭建交通流生成模块，通过自建车辆行为模型实现虚拟车辆的行为的按需仿真。SUMO可利用的车辆行为模型有直行、左转、右转以及跟车、换道模型等，以此实现多辆虚拟车辆之间的交互。基于路网信息，能够真实地模拟较大规模的交通流，并支持对其中每一辆虚拟车动态位姿信息的获取。

  为了将交通微观仿真系统上模拟的交通流注入到仿真平台上并进行后续的仿真，将交通流中的每一辆车实例化为仿真平台上的一个车辆客户端，在模拟过程中同时运行若干车辆客户端并与交通微观仿真平台SUMO进行实时交互联测，达到交通流模拟的目的。

  在利用仿真平台和交通微观仿真服务器进行联测的过程中，仿真平台借助交通微观仿真服务器广播的车辆的新的位姿信息和时间戳信息控制虚拟车辆的行为，定时向服务器发送当前的行驶状态，服务器获取所有虚拟仿真车辆的行驶状态并按照收到的行驶状态更新交通流后开始进行下一轮交通仿真，以此实现仿真平台和交通微观仿真服务器的联测机制。

  在对真实交通流的模拟过程中，由于Carla中虚拟车辆的道路行为决策需要借助SUMO服务器的交通模型仿真获得，因此要求在模拟过程中保持SUMO服务器和Carla客户端虚拟车辆之间的数据同步，即需要通过同步仿真算法来保证仿真过程中双端数据交互的准确性、实时性和鲁棒性。
  具体地，为了达到如上所述的目标，需要从消息交互、服务器端和客户端三方面入手，分别做相应的处理，来尽可能地保证车辆道路行为的正确呈现。
  消息交互方面，交通微观仿真服务器和仿真平台客户端双端主要需要在三个阶段进行消息的交互：建立连接阶段、单步仿真阶段和连接关闭阶段。在连接建立的阶段，服务器端收到仿真平台客户端的连接建立请求后，在交通微观仿真服务器的仿真场景中随机选择初始位置和路线并生成新的车辆，将初始位置发送给客户端；在每次进行单步仿真时，服务器向所有已建立连接的车辆发送当前仿真的行驶路点，客户端按照行驶路点行驶完成后需要向服务器通报行驶结果；当服务器的仿真场景中的某一车辆行驶到终点后，该车辆的实例会自动被回收，此时服务器需要向客户端发送仿真结束的消息，以通知客户端结束行驶。

  另外，在上述基本消息的基础上，为了保证仿真的正确性，需要额外定义一些辅助消息。首先，考虑到网络环境的不稳定性和虚拟车辆在某些情况下可能无法继续正常行驶的情况（如意外行驶到道路外且无法正常返回等），增设了客户端定时向服务器发送的心跳包，如果服务器一定时间内没有收到某一客户端的心跳包，则将此客户端车辆从服务器的仿真场景中移除。	

  客户端方面，应当最先被考虑的问题是客户端发送行驶结果数据包给服务器的时机问题。在初始的实现方案中，每当车辆的当前位置与任一路点的距离小于一个定值（与地图的规模有关），就认为该路点已经到达，记录完成行驶的路点。当已完成路点的数量等于服务器发送路点个数时，则认为当前阶段行驶结束，向服务器发送行驶结果。

  但这一实现方案有一个比较明显的缺陷，考虑到虚拟车辆在仿真场景中会因红灯、车辆拥塞等场景因素而减速或停车等待，车辆往往会在较长一段时间后才行驶完成给定路点。在这种情况下，如果此时仿真场景中有多个客户端行驶，服务器的同步仿真就难以继续正确进行。因此，一种更加合理的方案是在上述方案的基础上增加一个超时机制，也即当超过一个较长的时间段（如10秒）没有行驶完成后，向服务器发送异常行驶情况的通报。服务器在收到异常通报后，在服务器的仿真场景中停下该车辆，并继续进行仿真（停下车辆的情况下，后续仿真不会再自动继续行驶）。在后续的仿真过程中，服务器不会再向该车辆发送后续的路点，直到该车辆的客户端正常行驶到了最初给定的目标路点，发送行驶结果消息给服务器，服务器端再重启对该车辆的仿真过程。这一改进方案基本可以克服同步仿真过程中因车辆预期之外的行驶情况出现的仿真无法正常同步的问题。

  最后是SUMO服务器方面的处理。服务器方面对同步仿真的应对相对简单，在上述消息定义和客户端处理两部分阐述的基础上，服务器端保存各个车辆的当前行驶状态（正常行驶、异常停车、行驶完成），并且在接收消息的同时设定一个计时器，接收到所有连接客户端的行驶结果消息或者计时器超时后进行下一步仿真，将进行一步仿真后的位置信息发送给正常行驶的各个车辆即可。

